{% load static %}

<html>
    <head>
        <title>Home</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <title>Modify Feature</title>
        <link rel="stylesheet" href="{% static 'bootstrap.min.css' %}" type="text/css">
        <style type="text/css">
            #controls {
                width: 512px;
            }
            #controlToggle {
                padding-left: 1em;
            }
            #controlToggle li {
                list-style: none;
            }
        </style>
        <script src="{% static "jquery.js" %}" type= "text/javascript"></script>
        <script src="{% static "OpenLayers.js" %}" type= "text/javascript"></script>
        <script src="{% static "BboxSelector.js" %}" type= "text/javascript"></script>
    </head>

    <body>
        <h1>RESCLIMA DURAN</h1>
        <a href="{% url 'login' %}">Iniciar Sesion</a>
        <div class="topnav">
            <a href="#">About</a>
            <a href="#">Contact</a> 
        </div>

        <div>
            <input id = "search_input" type="text" placeholder="Buscar...">
            <button id="search_button" type="button">ยบ\</button>
        </div>
        <br>
        
        <div id="bbox_selector_container">
        </div>
      
        <div id="results_container">
        </div>
    </body>
    
    <script>
        var bboxSelector;
        
        function renderResults(results){
            var layers = results["layers"];
            var length = layers.length;
            if(length == 0){
                results_container.innerHTML = "<h3>No hay resultados</h3>"
                return;
            }
            results_container.innerHTML = "";

            for(var i=0; i< length; i++){
                var layer = layers[i];
                var div = document.createElement("div");
                var h3 = document.createElement("h3");
                h3.innerHTML = layer["title"];
                var h5 = document.createElement("h5");
                h5.innerHTML = layer["abstract"];
                var a = document.createElement("a");
                a.innerHTML = "Visualizar"
                a.href = layer["type"]+"/view/"+layer["id"];

                div.appendChild(h3);
                div.appendChild(h5);
                div.appendChild(a);
                div.style.borderStyle = "solid";
                div.style.borderWidth = "2px";
                div.style.borderColor = "blue";
                div.style.padding = "5px";

                results_container.appendChild(div);
            }
        }

        function search(text_query,bbox){

            if(text_query==""){
                return;
            }
            var url = "search/layer?q="+text_query+"&left="+String(bbox["minX"])+"&right="+String(bbox["maxX"]+"&bottom="+String(bbox["minY"])+"&top="+String(bbox["maxY"]));
            var request = $.get(url);
            request.done(function(results){
                renderResults(results)
            })

        }

        
        function init(){
            
            var map_container = document.getElementById("bbox_selector_container");
            bboxSelector = new BboxSelector(map_container);

            search_button.addEventListener("click",function(event){
                var text_query = search_input.value;
                var bbox = bboxSelector.getBBox();
                console.log("****El bounding box",bbox);
                search(text_query,bbox);
            });
        }

        
            

        window.addEventListener("load",init);
    </script>
</html>