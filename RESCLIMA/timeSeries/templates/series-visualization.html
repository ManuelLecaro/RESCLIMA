{% extends 'main/base.html' %}
{% load static %}

{% block title%}RESCLIMA | VISUALIZAR SERIES DE TIEMPO{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<body>
  
  <div id="div1"></div>
  <div id="div2"></div>

</body>
{% endblock content %}

{% block scripts_body %}
<script type="text/javascript">

   //get data from url
   var urlParams = new URLSearchParams(window.location.search);
   var ini_date = urlParams.get("ini_date"); 
   var end_date = urlParams.get("end_date")
   var variableParams = urlParams.get("variables");

   //parse data
	var variables_info = variableParams.split("|");
	var params = {}
	var imax = variables_info.length
	for(var i=0 ; i<imax ; i++){
		//get the variable id
		var current = variables_info[i];
		var variable_id = current.charAt(0);
		//get variables of stations
		var estaciones_str = current.slice(2,current.length-1);
		var estaciones = estaciones_str.split(",");
		params["variable_id"] = variable_id;
		params["stations_list"] = estaciones;
	}
	params["ini_date"] = ini_date;
	params["end_date"] = end_date;

	//get the data from the server
	for(var key in params){
		//make an ajax request per variable
		
		$.ajax({ url : "http://127.0.0.1:8000/series/measurements/", 
			type:"POST",
			data: { "info": JSON.stringify(params) },
			
			success : function(json) { 
				var div = "<div id=\"div"+json["variable_id"]+"\"></div>";
				$( "body" ).append(div);
				console.log(json["measures"]);

				//here goes plotly
				var div_id = "div"+json["variable_id"];
				//plotTimeSerie(json["measures"],div_id);
	      		variableTimeSerie();
				},
	    
			error : function(data) {
			 console.log("oh no :("); 
			 	} ,
			dataType: "json" 
		 });	
	
	};
	

//Plotly.newPlot('div2', data, layout2);
	function plotTimeSerie(stations_dict, div_id){
		to_plot = []
		for(var key in stations_dict){
			values = []
			dates = []
			for(var key_date in stations_dict[key]){
				for(var i=0; i<stations_dict[key][key_date].length; i++){
					values.push(stations_dict[key][key_date][i]);
					dates.push(key_date);
				}

			}
			
			//generate a trace per each station
			var trace = {dates,values,type:'scatter'};
			to_plot.push(trace);
		} 
		//draw
		var layout1 = {
	  yaxis: {rangemode: 'tozero',
	          showline: true,
	          zeroline: true}
	};

		Plotly.newPlot(div_id, to_plot, layout1);
	}
  
 function variableTimeSerie(){
    
	  var trace1 = {
	  x: [1, 2, 3, 4], 
	  y: [10, 15, 13, 17], 
	  type: 'scatter'
	};
	var trace2 = {
	  x: [1, 2, 3, 4], 
	  y: [16, 5, 11, 9], 
	  type: 'scatter'
	};
	var data = [trace1, trace2];

	var layout1 = {
	  yaxis: {rangemode: 'tozero',
	          showline: true,
	          zeroline: true}
	};

	var layout2 = {
	  yaxis: {rangemode: 'tozero',
	          zeroline: true}
	};

	Plotly.newPlot('div1', data, layout1);
	   }

    
</script>
{% endblock %}
