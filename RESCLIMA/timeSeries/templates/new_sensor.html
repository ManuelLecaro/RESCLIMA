{% extends 'main/base.html' %}
{% load static %}

{% block title%}RESCLIMA | SERIES DE TIEMPO{% endblock %}

{% block content %}
<body class="cyan">
  <div id="errorMsg"></div>
    <!--start container-->
    <div class="container">
        <div class="section">
          <!-- Form with icon prefixes -->
          <div class="row">
              <div class="col s12 m12 l6">
                <div class="card-panel">
                  <h4 class="header2">Ingreso de estaci&oacute;n</h4>
                  <div class="row">
                    <form method="post" id="StationForm">
                      {% csrf_token %}
                      <!-- Tipo estacion -->
                      <div class="row">
                        <div class="input-field col s12">  
                          <p>
                          <i class="material-icons prefix">device_hub</i>
                          <select id="id_stationType" name="stationType">
                          {% for station_type in station_types  %}
                            <option value={{station_type.id}} data-automatic={{station_type.automatic}}>{{station_type}} </option>
                          {% endfor %}
                          </select>
                          <label>Tipo de estaci&oacute;n</label>
                          </p>
                        </div>
                      </div>
                      <!-- Numero serial -->
                      <div class="row">
                        <div class="input-field col s12">
                          <p>
                              <i class="material-icons prefix">add_to_photos</i>
                              <input id="id_serialNum" name="serialNum" type="text"/>
                              <label for="id_serialNum">NÃºmero serial</label>
                            </p>
                        </div>
                      </div>
                      <!-- Ingreso latitud -->
                      <div class="row">
                        <div class="input-field col s12">
                          <p>
                              <i class="material-icons prefix">place</i>
                              <input id="id_latitude" name="latitude" step="0.000001" type="number" />
                              <label for="id_latitude">Latitud</label>
                            </p>
                        </div>
                      </div>
                      <!-- Ingreso longitud -->
                      <div class="row">
                          <div class="input-field col s12">
                                <p>
                                    <i class="material-icons prefix">place</i>
                                    <input id="id_longitude" name="longitude" step="0.000001" type="number" />
                                    <label for="id_longitude">Longitud</label>
                                </p>
                          </div>
                        </div>
                      
                      <!-- Ingreso frecuencia -->
                      <div class="row">
                          <div class="input-field col s12">
                              <p class="optional">
                                  <i class="material-icons prefix">poll</i>
                                  <label for="id_frequency">Frecuencia de requerimientos (en minutos)</label>
                                  <input id="id_frequency" name="frequency" step="1" type="number" />
                                </p>
                          </div>
                        </div>
                      <!-- Ingreso token -->
                      <div class="row">
                        <div class="input-field col s12">
                          <p class="optional">
                            <i class="material-icons prefix">domain</i>
                            <input id="id_token" name="token" type="text" />
                            <label for="id_token">Token</label>
                          </p>
                        </div>

                        <div class="row">
                          <div class="input-field col s12">
                              <input class="waves-effect waves-light btn gradient-45deg-light-blue-cyan" type="submit" id="Upload" value="Guardar"/>
                              <a onClick="javascript:history.go(-1);" style="margin-top: 0;" class="waves-effect waves-light btn gradient-45deg-red-pink">Cancelar</a>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              <!-- End form with icons-->
            </div>
        </div>  
      </div>
    </div>
  </body>
{% endblock content %}


<script>

    var form = $("#StationForm");

    function errorHandler(data){
      status = String(data.status);
      msg = "<b><i>Ha ocurrido un error " + status+ " en el servidor</i></b>"
      errorMsg.innerHTML = msg;
      console.log(data);
    }

    function successHandler(data){
      if(data=="OK"){
        window.location = "/series"
      }
      else{
        errorMsg.innerHTML = "<b><i>"+data+"</i></b>"
      }
    }


    function formSubmit(){
      var data = new FormData(form.get(0));
      $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: data,
        processData: false,
        contentType: false,
        success: successHandler,
        error: errorHandler
      });

      return false;
    }


    function hideOrShowOptional(option){
      console.log("me llamaron")
      var automatic = option.dataset["automatic"]
      var options = document.querySelectorAll(".optional");
      var display = "";

      var display = (automatic=="True")?"":"None";

      for(var i=0; i < options.length; i++){
        var x = options[i];
        x.style.display = display;
      }
    }

    function init(){
      var sensorTypes = document.getElementById("id_stationType");
      var options = sensorTypes.options;
      var option = options[options.selectedIndex];
      hideOrShowOptional(option);

      sensorTypes.addEventListener("change", function(e){
        var target = e.target;
        var options = target.options;
        var option = target[target.selectedIndex];
        hideOrShowOptional(option);      
      });

      form.submit(formSubmit);

    }

    $(document).ready(init);


  </script>

