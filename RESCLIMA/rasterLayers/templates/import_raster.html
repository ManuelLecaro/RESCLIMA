{% load static %}
<html>
  <head>
    <title>RESCLIMA DURAN</title>
    <script src="{% static "main/js/jquery.js" %}" type= "text/javascript"></script>
  </head>
  <body>
    <h1>Importar Raster</h1>
    <div id="errorMsg"></div>
    <form enctype="multipart/form-data" method="post"
          action="import" id="rasterForm">
      {{ form.as_p }}
      <p><label>Fecha de los datos</label><input type="date" name="data_date" id="data_date"/></p>
      <input type="submit" id="Upload" value="Subir"/>
      <button type="button" id="Cancel" onClick='window.location="/raster";'>Cancelar</button>
    </form>
    <div>
    <h3 id="uploadPercent"></h3>
    <div>
  </body>
  <script>
    var form = $("#rasterForm");

    function createXHR(){
      var xhr = new window.XMLHttpRequest();
      xhr.upload.addEventListener("progress",function(evt){
        if (evt.lengthComputable) {
          var percentComplete = evt.loaded / evt.total;
          percentComplete = parseInt(percentComplete * 100);
          if (percentComplete === 100){
            uploadPercent.innerHTML = "Completado, espere por favor"
            return;
          }
          uploadPercent.innerHTML = "Subido " + String(percentComplete) + "% ..."
        }

      },false);
      return xhr;
    }

    function successHandler(data){
      if(data=="OK"){
        window.location = "/raster"
      }
      else{
        console.log("No fue OK")
        errorMsg.innerHTML = "<b><i>"+data+"</i></b>"
        uploadPercent.innerHTML = "";
      }
    }

    function errorHandler(data){
      console.error(data)
      status = String(data.status);
      msg = "<b><i>Ha ocurrido un error " + status+ " en el servidor</i></b>"
      errorMsg.innerHTML = msg;
      uploadPercent.innerHTML = "";
    }
    
    function formSubmit(){
      var data = new FormData(form.get(0));
      $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: data,
        processData: false,
        contentType: false,
        xhr: createXHR,
        success: successHandler,
        error: errorHandler
      });

      return false;
    }

    $(document).ready(function() {
      document.getElementById('data_date').valueAsDate = new Date();
      form.submit(formSubmit);
    });
 
  </script>
</html>
